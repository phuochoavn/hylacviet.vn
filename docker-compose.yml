#===============================================================================
# HYLACVIET.VN - DOCKER COMPOSE
# Infrastructure Stack for MedusaJS v2 + Next.js E-commerce
#===============================================================================
# Generated: Wed Jan 21 03:07:08 UTC 2026
#===============================================================================

networks:
  traefik-public:
    name: traefik-public
    driver: bridge
  medusa-internal:
    name: medusa-internal
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  minio_data:
  kuma_data:

services:
  #=============================================================================
  # TRAEFIK - Edge Router & SSL
  #=============================================================================
  traefik:
    image: traefik:v2.11
    container_name: traefik
    restart: always
    security_opt:
      - no-new-privileges:true
    ports:
      - "80:80"
      - "443:443"
    environment:
      - CF_DNS_API_TOKEN=${CLOUDFLARE_API_TOKEN}
      - DOCKER_API_VERSION=1.52
      - ACME_EMAIL=${CLOUDFLARE_EMAIL}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/dynamic:/etc/traefik/dynamic:ro
      - ./traefik/acme.json:/letsencrypt/acme.json
    networks:
      - traefik-public
    labels:
      - "traefik.enable=false"

  #=============================================================================
  # POSTGRESQL - Database
  #=============================================================================
  postgres:
    image: postgres:16-alpine
    container_name: postgres
    restart: always
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres/init:/docker-entrypoint-initdb.d:ro
    networks:
      - medusa-internal
    command:
      - "postgres"
      - "-c"
      - "shared_buffers=256MB"
      - "-c"
      - "max_connections=100"
      - "-c"
      - "effective_cache_size=768MB"
      - "-c"
      - "maintenance_work_mem=64MB"
      - "-c"
      - "checkpoint_completion_target=0.9"
      - "-c"
      - "wal_buffers=8MB"
      - "-c"
      - "random_page_cost=1.1"
      - "-c"
      - "effective_io_concurrency=200"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      - "traefik.enable=false"

  #=============================================================================
  # REDIS - Event Bus & Cache
  #=============================================================================
  redis:
    image: redis:7.4-alpine
    container_name: redis
    restart: always
    volumes:
      - redis_data:/data
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    networks:
      - medusa-internal
    command: redis-server /usr/local/etc/redis/redis.conf
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      - "traefik.enable=false"

  #=============================================================================
  # MINIO - Object Storage (S3-Compatible)
  #=============================================================================
  minio:
    image: minio/minio:latest
    container_name: minio
    restart: always
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    volumes:
      - minio_data:/data
    networks:
      - traefik-public
      - medusa-internal
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 30s
      timeout: 20s
      retries: 3
    labels:
      - "traefik.enable=true"
      # MinIO API (S3)
      - "traefik.http.routers.minio-api.rule=Host(`cdn.hylacviet.vn`)"
      - "traefik.http.routers.minio-api.entrypoints=websecure"
      - "traefik.http.routers.minio-api.tls.certresolver=cloudflare"
      - "traefik.http.routers.minio-api.service=minio-api"
      - "traefik.http.services.minio-api.loadbalancer.server.port=9000"
      # MinIO Console - minio.hylacviet.vn
      - "traefik.http.routers.minio-console.rule=Host(`minio.hylacviet.vn`)"
      - "traefik.http.routers.minio-console.entrypoints=websecure"
      - "traefik.http.routers.minio-console.tls.certresolver=cloudflare"
      - "traefik.http.routers.minio-console.service=minio-console"
      - "traefik.http.services.minio-console.loadbalancer.server.port=9001"

  #=============================================================================
  # UPTIME KUMA - Monitoring
  #=============================================================================
  uptime-kuma:
    image: louislam/uptime-kuma:latest
    container_name: uptime-kuma
    restart: always
    volumes:
      - kuma_data:/app/data
    networks:
      - traefik-public
      - medusa-internal
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.kuma.rule=Host(`kuma.hylacviet.vn`)"
      - "traefik.http.routers.kuma.entrypoints=websecure"
      - "traefik.http.routers.kuma.tls.certresolver=cloudflare"
      - "traefik.http.routers.kuma.middlewares=secure-headers@file"
      - "traefik.http.services.kuma.loadbalancer.server.port=3001"

#===============================================================================
# PLACEHOLDER SERVICES (Uncomment when ready to deploy applications)
#===============================================================================

  # medusa-server:
  #   image: node:20-alpine
  #   container_name: medusa-server
  #   restart: always
  #   working_dir: /app
  #   environment:
  #     - MEDUSA_WORKER_MODE=server
  #     - DATABASE_URL=postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
  #     - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379
  #   volumes:
  #     - ./backend:/app
  #   networks:
  #     - traefik-public
  #     - medusa-internal
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #     redis:
  #       condition: service_healthy
  #   labels:
  #     - "traefik.enable=true"
  #     - "traefik.http.routers.medusa.rule=Host(`api.hylacviet.vn`)"
  #     - "traefik.http.routers.medusa.entrypoints=websecure"
  #     - "traefik.http.routers.medusa.tls.certresolver=cloudflare"
  #     - "traefik.http.services.medusa.loadbalancer.server.port=9000"

  # medusa-worker:
  #   image: node:20-alpine
  #   container_name: medusa-worker
  #   restart: always
  #   working_dir: /app
  #   environment:
  #     - MEDUSA_WORKER_MODE=worker
  #     - DATABASE_URL=postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
  #     - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379
  #   volumes:
  #     - ./backend:/app
  #   networks:
  #     - medusa-internal
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #     redis:
  #       condition: service_healthy
  #   deploy:
  #     resources:
  #       limits:
  #         memory: 800M
  #         cpus: '0.5'

  # nextjs:
  #   image: node:20-alpine
  #   container_name: nextjs
  #   restart: always
  #   working_dir: /app
  #   environment:
  #     - NEXT_PUBLIC_MEDUSA_BACKEND_URL=https://api.hylacviet.vn
  #     - NEXT_PUBLIC_CDN_URL=https://cdn.hylacviet.vn
  #   volumes:
  #     - ./frontend:/app
  #   networks:
  #     - traefik-public
  #   labels:
  #     - "traefik.enable=true"
  #     - "traefik.http.routers.nextjs.rule=Host(`hylacviet.vn`) || Host(`www.hylacviet.vn`)"
  #     - "traefik.http.routers.nextjs.entrypoints=websecure"
  #     - "traefik.http.routers.nextjs.tls.certresolver=cloudflare"
  #     - "traefik.http.services.nextjs.loadbalancer.server.port=3000"
